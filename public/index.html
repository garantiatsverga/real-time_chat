<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Chat с Supabase</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1>Dark Real-time Чат</h1>
            <div class="connection-status" id="connectionStatus">Отключен</div>
        </div>
        
        <div id="authSection" class="auth-section">
            <h3>Присоединиться к чату</h3>
            <input type="text" id="usernameInput" class="auth-input" placeholder="Имя пользователя" value="ТестовыйПользователь">
            <input type="text" id="userIdInput" class="auth-input" placeholder="ID пользователя (опционально)">
            <br>
            <button class="auth-btn" onclick="joinChat()">Войти в чат</button>
            <div id="authError" class="error-message"></div>
        </div>
        
        <div id="chatSection" style="display: none;">
            <div class="online-users">
                <strong>Онлайн:</strong> 
                <span class="online-users-count" id="onlineUsersCount">0</span>
                <span id="onlineUsersList"></span>
            </div>
            
            <div id="messages" class="messages"></div>
            
            <div id="typingIndicator" class="typing-indicator"></div>
            
            <div class="input-area">
                <input type="text" id="messageInput" class="message-input" 
                       placeholder="Введите ваше сообщение..." onkeypress="handleKeyPress(event)"
                       disabled>
                <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>Отправить</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let currentUser = null;
        let typingTimer = null;

        // Элементы страницы
        const authSection = document.getElementById('authSection');
        const chatSection = document.getElementById('chatSection');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const onlineUsersCount = document.getElementById('onlineUsersCount');
        const typingIndicator = document.getElementById('typingIndicator');
        const connectionStatus = document.getElementById('connectionStatus');
        const usernameInput = document.getElementById('usernameInput');
        const userIdInput = document.getElementById('userIdInput');
        const authError = document.getElementById('authError');
        const sendBtn = document.getElementById('sendBtn');

        // Присоединение к чату
        function joinChat() {
            const username = usernameInput.value.trim();
            if (!username) {
                showAuthError('Введите имя пользователя');
                return;
            }

            // Генерируем случайный ID пользователя если не указан
            const userId = userIdInput.value.trim() || 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            currentUser = { username, userId };
            
            // Показываем состояние загрузки
            document.body.classList.add('loading');
            
            // Подключаемся к серверу
            socket = io();
            
            // Обработчики событий
            socket.on('connect', () => {
                connectionStatus.textContent = 'Подключен';
                connectionStatus.style.color = '#4fc3f7';
                
                // Присоединяемся к чату
                socket.emit('join_chat', currentUser);
                authSection.style.display = 'none';
                chatSection.style.display = 'block';
                
                // Активируем поле ввода сообщения
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
                
                document.body.classList.remove('loading');
            });

            socket.on('disconnect', () => {
                connectionStatus.textContent = 'Отключен';
                connectionStatus.style.color = '#ff6b6b';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                document.body.classList.remove('loading');
            });

            socket.on('connect_error', (error) => {
                showAuthError('Ошибка подключения к серверу: ' + error.message);
                document.body.classList.remove('loading');
            });

            socket.on('duplicate_connection', () => {
                displaySystemMessage('Установлено новое соединение');
            });

            socket.on('message_history', (messages) => {
                console.log('Получена история сообщений:', messages);
                messagesDiv.innerHTML = '';
                messages.forEach(message => displayMessage(message));
                scrollToBottom();
            });

            socket.on('receive_message', (message) => {
                console.log('Получено новое сообщение:', message);
                displayMessage(message);
                scrollToBottom();
            });

            socket.on('user_joined', (data) => {
                displaySystemMessage(data.message);
            });

            socket.on('user_left', (data) => {
                displaySystemMessage(data.message);
            });

            socket.on('user_typing', (data) => {
                typingIndicator.textContent = data.username + ' печатает...';
            });

            socket.on('user_stop_typing', () => {
                typingIndicator.textContent = '';
            });

            socket.on('online_users_update', (users) => {
                const userCount = users.length;
                onlineUsersCount.textContent = userCount;
                
                // Отображаем список пользователей
                if (users.length > 0) {
                    const userNames = users.map(user => user.username).join(', ');
                    onlineUsersList.textContent = userNames;
                    onlineUsersList.className = 'user-list';
                } else {
                    onlineUsersList.textContent = 'нет пользователей';
                    onlineUsersList.className = '';
                }
            });

            socket.on('error', (error) => {
                console.log('Ошибка:', error);
                displaySystemMessage('Ошибка: ' + error.message, true);
                document.body.classList.remove('loading');
            });
        }

        // Отправка сообщения
        function sendMessage() {
            const text = messageInput.value.trim();
            if (text && socket) {
                console.log('Отправка сообщения:', text);
                socket.emit('send_message', { text });
                messageInput.value = '';
                clearTimeout(typingTimer);
                socket.emit('typing_stop');
            }
        }

        // Обработка нажатия клавиш
        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            } else if (socket) {
                // Уведомление о наборе текста
                socket.emit('typing_start');
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    socket.emit('typing_stop');
                }, 1000);
            }
        }

        // Вспомогательные функции
        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            // Проверяем, является ли сообщение нашим
            if (currentUser && message.user_id === currentUser.userId) {
                messageDiv.classList.add('my-message');
            }
            
            const timestamp = new Date(message.created_at).toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${escapeHtml(message.username || 'Неизвестный')}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-text">${escapeHtml(message.text)}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
        }

        function displaySystemMessage(text, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            if (isError) {
                messageDiv.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
                messageDiv.style.borderLeftColor = '#ff6b6b';
                messageDiv.style.color = '#ff6b6b';
            }
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }

        // Автоматический фокус на поле ввода имени
        usernameInput.focus();
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinChat();
            }
        });

        // Автоматический фокус на поле ввода сообщения после входа
        messageInput.addEventListener('keypress', handleKeyPress);
    </script>
</body>
</html>